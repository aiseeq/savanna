### **Часть 1: Анализ Текущей Ситуации**

Прежде чем переходить к плану, важно понять, *почему* мы оказались в этой точке.

#### **Анализ Процесса Разработки (по логам промптов)**

1.  **Реактивный, а не проактивный подход:** Разработка велась в режиме "тушения пожаров". Вы обнаруживали баг, давали команду его исправить. LLM вносил локальное изменение, которое часто ломало что-то другое. Отсутствовала стратегия системного исправления.
2.  **Ненадежные тесты:** Вы многократно указывали, что тесты проходят, а функционал не работает. Это классический признак того, что тесты проверяют не реальное поведение, а моки или некорректные условия. LLM не смог самостоятельно написать тесты, которые бы ловили регрессии.
3.  **"Ложная уверенность" LLM:** Модель часто заявляла о решении проблемы, не имея возможности его верифицировать (`make test`, визуальный анализ). Это приводило к циклам разочарования и необходимости вашего ручного вмешательства. Ваша система с двумя агентами (исполнитель/проверяющий) — это правильный шаг для борьбы с этим.
4.  **Дрейф архитектуры:** Из-за постоянных правок "на лету" ключевые архитектурные принципы (порядок систем, единицы измерения) нарушались, что приводило к хаотичному поведению (слишком быстрые животные, проблемы с питанием).

#### **Анализ Кода и Технического Долга**

1.  **Ключевой баг системы питания:** Зайцы не наедаются, потому что система голода (`HungerSystem`, которая *уменьшает* сытость) и система поедания (`GrassEatingSystem`, которая *увеличивает* сытость) работают некорректно. Скорее всего, уменьшение голода за тик больше, чем увеличение от одного "укуса" травы, или же порядок вызова систем нарушен. **Это баг №1.**
2.  **Путаница с единицами измерения:** В коде смешаны *тайлы* и *пиксели*. Физика и поведение должны работать исключительно в тайлах. Рендеринг — в пикселях. Это приводит к огромным скоростям и радиусам, которые вы наблюдали.
3.  **Нестабильное поведение ("Кластеризация в углах"):** Алгоритм побега у зайцев слишком примитивен (просто инвертировать вектор от хищника), что загоняет их в углы.
4.  **Неэффективная система столкновений:** Текущая система расталкивания слишком агрессивна, что приводит к "разбрасыванию" животных.
5.  **Нарушения SOLID и DRY:** Несмотря на рефакторинг, остались места с захардкоженными значениями и дублированием логики, особенно в тестах.

---

### **Часть 2: План Работ по Исправлению и Стабилизации**

Этот план разбит на три этапа. Каждый этап решает конкретный класс проблем и создает основу для следующего.

#### **ЭТАП 1: Закладываем фундамент (стабильность и наблюдаемость)**

*Цель: Привести проект к состоянию, когда мы можем доверять симуляции и легко настраивать ее параметры.*

**ЗАДАЧА 1.1: Унификация Единиц Измерения (Принцип: Единая Истина)**
-   **Проблема:** Смешение пикселей и тайлов в логике симуляции.
-   **Действия:**
    1.  Создать в `internal/constants` набор функций-конвертеров: `TilesToPixels()`, `PixelsToTiles()`, `SizeRadiusToTiles()`, `SizeAttackRangeToTiles()`.
    2.  Провести глобальный рефакторинг:
        *   Все константы в `game_balance.go` должны быть **в тайлах**.
        *   Вся логика в `internal/simulation` и `internal/physics` должна работать **с тайлами**.
        *   Компоненты `core.Position` и `core.Size` хранят значения **в пикселях** (т.к. они ближе к рендерингу).
        *   Система `MovementSystem` должна на входе получать `Velocity` в тайлах/сек, а внутри конвертировать ее в пиксели/сек для обновления `Position`.
    3.  Написать юнит-тест `speed_verification_test.go`, который проверяет, что животное со скоростью `1.0 тайл/сек` за 1 секунду симуляции перемещается ровно на `32` пикселя.

**ЗАДАЧА 1.2: Рефакторинг Фабрики Животных (Принцип: DRY)**
-   **Проблема:** Логика создания животных размазана и использует нецентрализованные константы.
-   **Действия:**
    1.  Убедиться, что `animal_factory.go` использует **только** константы из `game_balance.go`.
    2.  Фабрика должна правильно конвертировать размеры из ТАЙЛОВ (из `game_balance.go`) в ПИКСЕЛИ для компонента `core.Size`.
    3.  Убедиться, что `AnimalConfig` создается и заполняется на основе констант из `game_balance.go` для каждого типа животных.

**ЗАДАЧА 1.3: Централизация Порядка Систем (Принцип: Детерминизм)**
-   **Проблема:** Порядок вызова систем в разных частях кода (main, тесты) может отличаться, что приводит к разному поведению.
-   **Действия:**
    1.  Создать в `tests/common/system_factory.go` функцию `CreateTestSystemManager()`, которая возвращает `*core.SystemManager` с системами, добавленными в **строго правильном порядке**, как указано в `CLAUDE.md`.
    2.  Переписать **ВСЕ** интеграционные тесты, чтобы они использовали эту фабрику для создания систем. Это гарантирует, что тесты и игра работают по одинаковым правилам.

---

#### **ЭТАП 2: Исправление Ключевых Механик (ядро геймплея)**

*Цель: Починить самые заметные и критичные баги в поведении животных.*

**ЗАДАЧА 2.1: Исправление Системы Питания Зайцев (TDD)**
-   **Проблема:** Зайцы едят, но не насыщаются, или насыщаются слишком быстро/медленно.
-   **Действия:**
    1.  Создать новый интеграционный тест `eating_frame_validation_test.go`.
    2.  **Given:** Голодный заяц стоит на клетке с травой.
    3.  **When:** Симулируем один тик с анимацией еды на **кадре 0**.
    4.  **Then:** Уровень сытости **НЕ** должен измениться.
    5.  **When:** Переключаем анимацию на **кадр 1** и симулируем еще один тик.
    6.  **Then:** Уровень сытости **ДОЛЖЕН** увеличиться ровно на `GrassPerEatingTick * GrassNutritionValue`.
    7.  **ИСПРАВИТЬ** код в `GrassEatingSystem` и `HungerSystem`, чтобы этот тест прошел. Вероятные причины бага:
        *   `HungerSystem` вызывается после `GrassEatingSystem`.
        *   Логика `previousFrames` в `GrassEatingSystem` некорректна.
        *   Зайцы перестают есть при достижении `RabbitHungerThreshold`, а не при полном насыщении. **Они должны есть до 100%**.

**ЗАДАЧА 2.2: Исправление Системы Атаки Волка (Принцип: State Machine)**
-   **Проблема:** Волк бросает недоеденного зайца и атакует другого.
-   **Действия:**
    1.  В `AttackSystem` добавить проверку: если у волка есть компонент `EatingState`, он **НЕ МОЖЕТ** создавать `AttackState`.
    2.  В `EatingSystem` добавить логику: волк ест труп до тех пор, пока `(питательность трупа > 0)` И `(голод волка < 100%)`.
    3.  Создать интеграционный тест `wolf_switching_targets_bug_test.go`. **Given:** 1 голодный волк, 2 зайца рядом. **When:** Симуляция. **Then:** Волк убивает первого зайца, **полностью** съедает его (труп исчезает), и только потом атакует второго.

**ЗАДАЧА 2.3: Исправление "Кластеризации в Углах" (Улучшение AI)**
-   **Проблема:** Зайцы, убегая, забиваются в углы.
-   **Действия:**
    1.  В `HerbivoreBehaviorStrategy` изменить логику побега.
    2.  К текущему вектору побега (`от хищника`) добавить **вектор отталкивания от ближайших границ мира**. Сила отталкивания должна быть обратно пропорциональна расстоянию до границы.
    3.  Создать интеграционный тест `corner_clustering_behavior_test.go`. **Given:** Мир 50x38, волк в центре, заяц у края. **When:** Симуляция. **Then:** Финальная позиция зайца не должна быть в углу карты (например, в пределах 10% от краев).

---

#### **ЭТАП 3: Полировка и Завершение MVP**

*Цель: Довести продукт до состояния, когда его можно показать. Все основные механики работают предсказуемо.*

**ЗАДАЧА 3.1: Восстановление и Фиксация UI**
-   **Проблема:** Хелсбары и показатели сытости либо отсутствуют, либо зависят от физических размеров, а не от спрайтов.
-   **Действия:**
    1.  Перенести всю логику рендеринга UI (хелсбары, сытость) в `gamestate`. Этот пакет должен генерировать `RenderInstructionSet`.
    2.  Размеры и смещения UI-элементов должны быть константами, а не зависеть от `core.Size` животного.
    3.  Написать тест `health_ui_display_test.go`, который проверяет, что для животных с `Health` и `Hunger` создаются соответствующие инструкции для рендеринга.

**ЗАДАЧА 3.2: Финальная Балансировка и Проверка**
-   **Проблема:** Скорости, урон и другие параметры могут быть несбалансированы.
-   **Действия:**
    1.  В `game_balance.go` установить финальные значения, которые обеспечивают интересный геймплей (например, те, что были в `docs/tasks/2025-06-23-rework.md`).
    2.  Запустить `debug_eating_system` (который теперь должен называться `debug_simulation`) и убедиться, что симуляция выглядит стабильной в течение 10-12 секунд.
    3.  Написать финальный тест `balance_verification_test.go`, который проверяет общую стабильность экосистемы за 10-15 секунд симуляции.

**ЗАДАЧА 3.3: Очистка Кода**
-   **Проблема:** Мертвый код, ненужные файлы, закомментированные участки.
-   **Действия:**
    1.  Удалить все `DEPRECATED` системы и адаптеры (`FeedingSystem`, `DeprecatedFeedingSystemAdapter`).
    2.  Прогнать `make lint --fix` и исправить все оставшиеся предупреждения.
    3.  Удалить ненужные отладочные файлы, оставив только `debug_eating_system`.
